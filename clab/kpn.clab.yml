# Copyright 2024 Nokia
# Licensed under the BSD 3-Clause License.
# SPDX-License-Identifier: BSD-3-Clause

name: kpn-hackathon

mgmt:
  network: kpn-hackathon # management network name
  ipv4-subnet: 10.128.${INSTANCE_ID}.0/24 # ipv4 range

topology:
  defaults:
    kind: linux
    image: ghcr.io/srl-labs/network-multitool
  kinds:
    nokia_srlinux:
      image: ghcr.io/nokia/srlinux:25.10.1
    linux:
      image: ghcr.io/srl-labs/network-multitool
  nodes:
    # DCF
    spine1:
      kind: nokia_srlinux
      type: ixr-h4-32d
      mgmt-ipv4: 10.128.${INSTANCE_ID}.31
      ports:
        - 50031:22
        - 50331:57400
    spine2:
      kind: nokia_srlinux
      type: ixr-h4-32d
      mgmt-ipv4: 10.128.${INSTANCE_ID}.32
      ports:
        - 50032:22
        - 50332:57400
    leaf1:
      kind: nokia_srlinux
      type: ixr-d3l
      mgmt-ipv4: 10.128.${INSTANCE_ID}.33
      ports:
        - 50033:22
        - 50333:57400
    leaf2:
      kind: nokia_srlinux
      type: ixr-d3l
      mgmt-ipv4: 10.128.${INSTANCE_ID}.34
      ports:
        - 50034:22
        - 50334:57400
    leaf3:
      kind: nokia_srlinux
      type: ixr-d3l
      mgmt-ipv4: 10.128.${INSTANCE_ID}.35
      ports:
        - 50035:22
        - 50335:57400
    borderleaf1:
      kind: nokia_srlinux
      type: ixr-d3l
      mgmt-ipv4: 10.128.${INSTANCE_ID}.36
      ports:
        - 50036:22
        - 50336:57400
    borderleaf2:
      kind: nokia_srlinux
      type: ixr-d3l
      mgmt-ipv4: 10.128.${INSTANCE_ID}.37
      ports:
        - 50037:22
        - 50337:57400
    client1:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.38
      binds:
        - configs/client/interfaces-client1:/etc/network/interfaces
        - configs/client/client.sh:/client.sh
        - configs/client/traffic.sh:/traffic.sh
      exec:
        - bash /client.sh
        - bash -c "echo 'nameserver 10.128.${INSTANCE_ID}.15' | sudo tee
          /etc/resolv.conf"
      ports:
        - 50038:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
    client2:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.39
      binds:
        - configs/client/interfaces-client2:/etc/network/interfaces
        - configs/client/client.sh:/client.sh
        - configs/client/traffic.sh:/traffic.sh
      exec:
        - bash /client.sh
        - bash -c "echo 'nameserver 10.128.${INSTANCE_ID}.15' | sudo tee
          /etc/resolv.conf"
      ports:
        - 50039:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
    client3:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.40
      binds:
        - configs/client/interfaces-client3:/etc/network/interfaces
        - configs/client/client.sh:/client.sh
        - configs/client/traffic.sh:/traffic.sh
      exec:
        - bash /client.sh
        - bash -c "echo 'nameserver 10.128.${INSTANCE_ID}.15' | sudo tee
          /etc/resolv.conf"
      ports:
        - 50040:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
    client4:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.41
      binds:
        - configs/client/interfaces-client4:/etc/network/interfaces
        - configs/client/client.sh:/client.sh
        - configs/client/traffic.sh:/traffic.sh
      exec:
        - bash /client.sh
        - bash -c "echo 'nameserver 10.128.${INSTANCE_ID}.15' | sudo tee
          /etc/resolv.conf"
      ports:
        - 50041:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
    client5:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.42
      binds:
        - configs/client/interfaces-client5:/etc/network/interfaces
        - configs/client/client.sh:/client.sh
        - configs/client/traffic.sh:/traffic.sh
      exec:
        - bash /client.sh
        - bash -c "echo 'nameserver 10.128.${INSTANCE_ID}.15' | sudo tee
          /etc/resolv.conf"
      ports:
        - 50042:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
    ### TELEMETRY STACK ###
    # gnmic:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.71
    #   image: ghcr.io/openconfig/gnmic:0.38.2
    #   binds:
    #     - configs/gnmic/config.yml:/gnmic-config.yml:ro
    #     - /var/run/docker.sock:/var/run/docker.sock:ro
    #   cmd: --config /gnmic-config.yml --log subscribe
    #   group: "10" # group 10 is assigned to the nodes of a telemetry stack
    #   env:
    #     GNMIC_PASSWORD: ${EVENT_PASSWORD}

    # prometheus:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.72
    #   image: quay.io/prometheus/prometheus:v2.51.2
    #   binds:
    #     - configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    #   ports:
    #     - 9090:9090
    #   cmd: --config.file=/etc/prometheus/prometheus.yml
    #   group: "10"

    # grafana:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.73
    #   image: grafana/grafana:10.3.5
    #   binds:
    #     - configs/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
    #     - configs/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
    #     - configs/grafana/dashboards:/var/lib/grafana/dashboards
    #   ports:
    #     - 3000:3000
    #   env:
    #     GF_INSTALL_PLUGINS: https://github.com/skyfrank/grafana-flowcharting/releases/download/v1.0.0e/agenty-flowcharting-panel-1.0.0e.231214594-SNAPSHOT.zip;agenty-flowcharting-panel
    #     # env vars to enable anonymous access
    #     GF_ORG_ROLE: "Editor"
    #     GF_ORG_NAME: "Main Org."
    #     GF_AUTH_ANONYMOUS_ENABLED: "true"
    #     GF_AUTH_ANONYMOUS: "true"
    #     GF_SECURITY_ADMIN_PASSWORD: ${EVENT_PASSWORD}
    #   cmd: "sh -c grafana cli admin reset-admin-password ${GF_SECURITY_ADMIN_PASSWORD}
    #     && /run.sh"
    #   group: "10"

    # ### LOGGING STACK ###
    # syslog:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.74
    #   image: quay.io/linuxserver.io/syslog-ng:4.5.0
    #   binds:
    #     - configs/syslog/syslog-ng.conf:/config/syslog-ng.conf:rslave
    #     - configs/syslog/log/messages:/var/log/messages:rslave
    #   env:
    #     PUID: 1001
    #     PGID: 1001

    # promtail:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.75
    #   image: grafana/promtail:2.9.7
    #   binds:
    #     - configs/promtail:/etc/promtail
    #   cmd: --config.file=/etc/promtail/promtail-config.yml

    # loki:
    #   mgmt-ipv4: 10.128.${INSTANCE_ID}.76
    #   image: grafana/loki:2.9.7
    #   binds:
    #     - configs/loki:/etc/loki
    #   cmd: --config.file=/etc/loki/loki-config.yml

    ### DNS ###
    dns:
      mgmt-ipv4: 10.128.${INSTANCE_ID}.15
      binds:
        - configs/dns/dns.sh:/client.sh
        - configs/dns/dnsmasq.tmpl.conf:/etc/dnsmasq.tmpl.conf
      exec:
        - bash -c "envsubst < /etc/dnsmasq.tmpl.conf | tee
          /etc/dnsmasq.d/dns.conf"
        - bash /client.sh
      ports:
        - 50015:22
      env:
        USER_PASSWORD: ${EVENT_PASSWORD}
        INSTANCE_ID: ${INSTANCE_ID}

  links:

    # links from spine1/2 to leafs
    - endpoints: [ "spine1:e1-1", "leaf1:e1-31" ]
    - endpoints: [ "spine1:e1-2", "leaf2:e1-31" ]
    - endpoints: [ "spine1:e1-3", "leaf3:e1-31" ]
    - endpoints: [ "spine2:e1-1", "leaf1:e1-32" ]
    - endpoints: [ "spine2:e1-2", "leaf2:e1-32" ]
    - endpoints: [ "spine2:e1-3", "leaf3:e1-32" ]
    # links from spine1/2 to borderleafs
    - endpoints: [ "spine1:e1-4", "borderleaf1:e1-31" ]
    - endpoints: [ "spine1:e1-5", "borderleaf2:e1-31" ]
    - endpoints: [ "spine2:e1-4", "borderleaf1:e1-32" ]
    - endpoints: [ "spine2:e1-5", "borderleaf2:e1-32" ]
    # links from leaf1/2/3 to clients
    - endpoints: [ "leaf1:e1-1", "client1:eth1" ]
    - endpoints: [ "leaf1:e1-2", "client2:eth1" ]
    - endpoints: [ "leaf2:e1-1", "client2:eth2" ]
    - endpoints: [ "leaf3:e1-1", "client3:eth1" ]
    - endpoints: [ "leaf3:e1-2", "client4:eth1" ]
    # links from borderleaf1/2 to clients
    - endpoints: [ "borderleaf1:e1-1", "client5:eth1" ]
    - endpoints: [ "borderleaf2:e1-1", "client5:eth2" ]